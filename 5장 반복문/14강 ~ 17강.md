# 5장 반복문

모든 엔지니어 또는 프로그래머는 공통적인 병을 가지고 있음. `반복문 의존병`

- SQL에는 반복문이 존재하지 않음
- 일부로 반복문을 언어 설계에 제외했음
- 반복계의 장점은 SQL을 잘 모르더라도 사용 할 수 있다.
- 여러행을 한꺼번에 처리하는 SQL을 `포장계` 라고함
- `포장계 SQL`은 비즈니스 로직을 SQL에 넣으려다 보니 `구문이 복잡`해져 유지 보수성이 떨어지는 SQL 구문이 만들어 지기도함

### 반복계의 단점

- 성능 → 반복계로 구현한 코드는 포장계로 구현한 코드에 성능적으로 이길 수가 없다.
- 근소한 차이가 아니라 `완벽하게 진다.`
- 반복계의 처리 시간은 처리 대상 `레코드 수에 선형적으로 증가`한다.
- SQL 실행의 오버 헤드 → SQL 실행할 때 실제의 SQL 처리 이외에도 다양한 처리가 이루어짐
    - 전처리
        1. SQL 구문을 네트워크로 전송
        2. 데이터베이스 연결
        3. SQL 구문파스
        4. SQL 구문의 실행 계획 생성 또는 평가
    - 후처리

        5. 결과과 집합을 네트워크로 전송

- 오버헤드중 가장 `영향이 큰것은 3 또는 4`
- 반복계 : 오버레드 + SQL 실행 * 반복
- 포장계 : 오버헤드 + SQL실행
- `포장계는 병렬 분산 가능 하지만 반복계는 분산불가`
    - 반복계에서 실행하는 SQL 구문은 대부분 단순해서 1회의 SQL 구문이 접근하는 데이터양이 적다. 따라서 I/O를 병렬화하기 힘들다는 단점
- `데이터베이스의 진화로 인한 혜택을 받을 수 없다.`
    - DBMS 벤더는 SQL을 빠르게 하기 위해 계속해서 연구중
    - 버전이 오를수록 옵티마지너는 보다 효율적으로 실행 계획을 세우며, 데이터에 고속으로 접근할 수 있는 아키텍처를 구현함
    - 이런 혜택은 구문이 단순한 반복계보다, 구문이 복잡한 포장계 SQL이 혜택을 받음
- 포장계의 SQL구문은 튜닝 가능성이 굉장히 높으므로 제대로 튜닝한다면 처음과 비교해서 현격한 성능차이가 있음
    - 반복계는 단지 느리기만 한것이 아니라 느린 구문을 튜닝할 수 있는 가능성도 거의 없다고 할 수 있음

## 반복계의 장점

- 실행계획의 안전성
    - 실행 계획이 단순하다는 것은 변동 위험이 거의 없다라는것
- 트랜잭션 제어가 편리
    - 중간에 오류가 발생하더라도 중간에 커밋을 했으므로 해당 지점 근처에서 다시 처리를 실행하면됨

## 포장계의 단점

- SQL 구문이 복잡한 만큼 실행 계획의 변동 가능성이 굉장히 큼
- 옵티마이저가 잘 할 것으로 생각하면 장점이고, 위험하다 생각하면 단점이 되는 부분
- 갱신 처리 중간에 오류가 발생하면, 처리를 처음부터 다시 실행해야 함

## SQL에서는 반복을 어떻게 표한할까?

- 반복 횟수가 정해져 있는 경우
    - 포인트는 CASE 식과 윈도우 함수
    - `ROWS BETWEEN 1 PRECENDING AND 1 PRECENDING`은 현재 레코드에서 `1개 이전부터 1개 이전까지 레코드 범위`를 나타내는것
- 반복 횟수가 정해지지 않은 경우
    - 인접리스트 모델과 재귀쿼리
        - 특정 컬럼을 키로 삼아 데이터를 줄줄이 연결한 것을 `포인터 체인` 이라함 → 이를 `인접 리스트 모델` 이라함
        - 재귀 :  `WITH RECURSIVE Explosion`
- SQL에서 계층 구조를 나타내는 방법 3가지
    1. 인접 리시트 모델 : 전통적인 방법
    2. 경로 열거 모델 : 갱신이 거의 발생하지 않는 경우 사용
    3. 중첩 집합 모델 : 계층 구조를 집ㅈ합의 중첩 관계로 나태내는 것
